<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Food Analyzer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/health-data-client@1.0.0/dist/health-data.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold text-center mb-8">
        Food Nutrition Analyzer
      </h1>

      <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
        <div class="mb-4">
          <div
            class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
          >
            <input
              type="file"
              id="imageInput"
              accept="image/*"
              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
            />
            <div class="space-y-1 text-center">
              <svg
                class="mx-auto h-12 w-12 text-gray-400"
                stroke="currentColor"
                fill="none"
                viewBox="0 0 48 48"
              >
                <path
                  d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <div class="text-sm text-gray-600">
                <label
                  for="imageInput"
                  class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500"
                >
                  Upload a photo
                </label>
                or drag and drop
              </div>
              <p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
            </div>
          </div>
        </div>

        <div id="imagePreview" class="hidden mb-4 relative">
          <img
            id="preview"
            src=""
            alt="Preview"
            class="max-w-full h-auto rounded-lg"
          />
          <div
            id="annotations"
            class="absolute top-0 left-0 w-full h-full"
          ></div>
        </div>

        <button
          id="analyzeBtn"
          class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50"
          disabled
        >
          Analyze Food
        </button>

        <div id="result" class="mt-4 hidden">
          <h2 class="text-xl font-semibold mb-2">Analysis Results</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="font-semibold mb-2">Overall Nutrition</h3>
              <div id="totalNutrition"></div>
              <canvas id="macroChart" class="mt-4"></canvas>
              <div id="dailyValue" class="mt-2"></div>
              <div
                id="healthScore"
                class="mt-4 p-3 bg-white rounded-lg border border-gray-200"
              >
                <!-- Health score will be inserted here -->
              </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="font-semibold mb-2">Detailed Analysis</h3>
              <div id="foodDetails"></div>
            </div>
          </div>

          <div class="mt-4 flex space-x-4">
            <button
              id="exportPDF"
              class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700"
            >
              Export PDF Report
            </button>
            <button
              id="compareMeal"
              class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
            >
              Compare Meals
            </button>
          </div>
        </div>

        <div id="error" class="mt-4 hidden">
          <div
            class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative"
          >
            <strong class="font-bold">Error!</strong>
            <span id="errorContent" class="block sm:inline"></span>
          </div>
        </div>

        <div id="loading" class="hidden mt-4 text-center">
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"
          ></div>
          <p class="mt-2 text-gray-600">Analyzing your food...</p>
        </div>

        <div class="mt-4 flex space-x-4">
          <button
            id="speakButton"
            class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700"
          >
            <svg
              class="w-5 h-5 inline-block mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
              />
            </svg>
            Read Analysis
          </button>

          <button
            id="syncHealthApp"
            class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
          >
            Sync to Health App
          </button>

          <button
            id="startAR"
            class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700"
          >
            Start AR Scanner
          </button>
        </div>

        <div id="mealHistory" class="mt-8 hidden">
          <h2 class="text-xl font-semibold mb-4">Meal History</h2>
          <div id="historyContent" class="space-y-4"></div>
        </div>

        <div id="arContainer" class="fixed inset-0 bg-black hidden">
          <video id="arVideo" class="w-full h-full object-cover"></video>
          <button
            id="closeAR"
            class="absolute top-4 right-4 bg-white text-black p-2 rounded-full"
          >
            ✕
          </button>
        </div>

        <div
          id="compareModal"
          class="fixed inset-0 bg-black bg-opacity-50 hidden"
        >
          <div class="bg-white p-6 rounded-lg max-w-4xl mx-auto mt-20">
            <h3 class="text-xl font-bold mb-4">Compare Meals</h3>
            <div class="grid grid-cols-2 gap-4">
              <div id="meal1" class="border p-4 rounded">
                <!-- Current meal data -->
              </div>
              <div id="meal2" class="border p-4 rounded">
                <input
                  type="file"
                  id="compareMealInput"
                  accept="image/*"
                  class="mb-4"
                />
                <!-- Second meal data will appear here -->
              </div>
            </div>
            <button
              id="closeCompare"
              class="mt-4 bg-gray-600 text-white py-2 px-4 rounded"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="tooltip"
      class="hidden fixed bg-white p-3 rounded-lg shadow-lg border border-gray-200 max-w-xs z-50"
    ></div>

    <script>
      const imageInput = document.getElementById("imageInput");
      const imagePreview = document.getElementById("imagePreview");
      const preview = document.getElementById("preview");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const result = document.getElementById("result");
      const resultContent = document.getElementById("resultContent");
      const loading = document.getElementById("loading");

      imageInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            imagePreview.classList.remove("hidden");
            analyzeBtn.disabled = false;
          };
          reader.readAsDataURL(file);
        }
      });

      function showTooltip(event, content) {
        const tooltip = document.getElementById("tooltip");
        tooltip.innerHTML = content;
        tooltip.style.left = `${event.pageX + 10}px`;
        tooltip.style.top = `${event.pageY + 10}px`;
        tooltip.classList.remove("hidden");
      }

      function hideTooltip() {
        document.getElementById("tooltip").classList.add("hidden");
      }

      function createFoodAnnotation(food, imageWidth, imageHeight) {
        const pos = food.position;
        const annotation = document.createElement("div");
        annotation.className = "absolute border-2 border-indigo-500";
        annotation.style.left = `${pos.x * 100}%`;
        annotation.style.top = `${pos.y * 100}%`;
        annotation.style.width = `${pos.width * 100}%`;
        annotation.style.height = `${pos.height * 100}%`;

        const label = document.createElement("div");
        label.className =
          "absolute -top-6 left-0 bg-indigo-500 text-white px-2 py-1 text-sm rounded";
        label.textContent = `${food.name} (${food.confidence}%)`;

        annotation.appendChild(label);
        return annotation;
      }

      analyzeBtn.addEventListener("click", async function () {
        const file = imageInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("image", file);

        loading.classList.remove("hidden");
        result.classList.add("hidden");
        document.getElementById("error").classList.add("hidden");
        analyzeBtn.disabled = true;

        try {
          const response = await fetch("/analyze", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.error) {
            document.getElementById("errorContent").textContent = data.error;
            document.getElementById("error").classList.remove("hidden");
          } else {
            const annotations = document.getElementById("annotations");
            annotations.innerHTML = "";

            data.foods.forEach((food) => {
              const annotation = createFoodAnnotation(
                food,
                preview.width,
                preview.height
              );
              annotations.appendChild(annotation);
            });

            const totalNutrition = document.getElementById("totalNutrition");
            totalNutrition.innerHTML = `
              <p>Total Calories: ${data.total.calories} kcal</p>
              <p>Carbs: ${data.total.carbs}g</p>
              <p>Proteins: ${data.total.proteins}g</p>
              <p>Fats: ${data.total.fats}g</p>
            `;

            const dailyValue = document.getElementById("dailyValue");
            dailyValue.innerHTML = `
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${data.daily_values.calorie_percentage}%"></div>
              </div>
              <p class="text-sm mt-1">${data.daily_values.calorie_percentage}% of daily calorie goal (2000 kcal)</p>
            `;

            const foodDetails = document.getElementById("foodDetails");
            foodDetails.innerHTML = data.foods
              .map(
                (food, index) => `
                <div class="mb-4 p-3 bg-white rounded border border-gray-200">
                  <h4 class="font-semibold flex items-center">
                    ${food.name}
                    ${
                      food.allergens.length > 0
                        ? `<span class="ml-2 text-yellow-500" title="Contains allergens">⚠️</span>`
                        : ""
                    }
                  </h4>
                  <div class="flex items-center mt-2">
                    <button onclick="updateServingSize(${index}, -0.5)" class="px-2 bg-gray-200 rounded">-</button>
                    <span class="mx-2">${
                      food.nutrition.serving_multiplier || 1
                    }x serving</span>
                    <button onclick="updateServingSize(${index}, 0.5)" class="px-2 bg-gray-200 rounded">+</button>
                  </div>
                  <p class="text-sm text-gray-600 mt-2">${food.origin}</p>
                  <button onclick="showCulturalInfo('${food.name}', '${
                  food.origin
                }')" 
                          class="text-blue-600 text-sm mt-1">Learn More</button>
                  <div class="mt-2">
                    ${food.dietary_labels
                      .map(
                        (label) => `
                      <span class="inline-block bg-gray-100 rounded-full px-3 py-1 text-sm mr-2 mb-2">
                        ${label}
                      </span>
                    `
                      )
                      .join("")}
                  </div>
                  <div class="mt-2">
                    <p>Per ${food.nutrition.serving_size}:</p>
                    <p>Calories: ${food.nutrition.calories} kcal</p>
                  </div>
                </div>
              `
              )
              .join("");

            createMacroChart(data);

            const healthScore = document.getElementById("healthScore");
            healthScore.innerHTML = `
              <div class="text-xl font-bold mb-2">
                Health Score: ${data.health_score}/10
              </div>
              <div class="text-sm">
                ${data.health_benefits
                  .map(
                    (benefit) =>
                      `<div class="text-green-600">✅ ${benefit}</div>`
                  )
                  .join("")}
                ${data.healthy_alternatives
                  .map((alt) => `<div class="text-yellow-600">⚠️ ${alt}</div>`)
                  .join("")}
              </div>
            `;

            result.classList.remove("hidden");
            localStorage.setItem("lastAnalysis", JSON.stringify(data));
          }
        } catch (error) {
          document.getElementById("errorContent").textContent = error.message;
          document.getElementById("error").classList.remove("hidden");
        } finally {
          loading.classList.add("hidden");
          analyzeBtn.disabled = false;
        }
      });

      function createMacroChart(data) {
        const ctx = document.getElementById("macroChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Carbs", "Protein", "Fat"],
            datasets: [
              {
                data: [data.total.carbs, data.total.proteins, data.total.fats],
                backgroundColor: [
                  "rgb(59, 130, 246)",
                  "rgb(239, 68, 68)",
                  "rgb(234, 179, 8)",
                ],
              },
            ],
          },
          options: {
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Grams",
                },
              },
            },
          },
        });
      }

      function updateServingSize(foodIndex, change) {
        const data = JSON.parse(localStorage.getItem("lastAnalysis"));
        const food = data.foods[foodIndex];
        const serving = food.nutrition.serving_multiplier || 1;
        food.nutrition.serving_multiplier = Math.max(0.5, serving + change);

        // Recalculate totals
        recalculateTotals(data);
        updateDisplayedNutrition(data);
      }

      function generatePDF() {
        const element = document.getElementById("result");
        const opt = {
          margin: 1,
          filename: "food-analysis.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };
        html2pdf().set(opt).from(element).save();
      }

      document
        .getElementById("exportPDF")
        .addEventListener("click", generatePDF);
      document.getElementById("compareMeal").addEventListener("click", () => {
        document.getElementById("compareModal").classList.remove("hidden");
      });
      document.getElementById("closeCompare").addEventListener("click", () => {
        document.getElementById("compareModal").classList.add("hidden");
      });

      // Voice narration
      function speakAnalysis(data) {
        const speech = new SpeechSynthesisUtterance();
        speech.text = `Analysis complete. Found ${data.foods.length} items. `;
        data.foods.forEach((food) => {
          speech.text += `${food.name} with ${food.nutrition.calories} calories. `;
        });
        speech.text += `Total calories: ${data.total.calories}. Health score: ${data.health_score} out of 10.`;
        window.speechSynthesis.speak(speech);
      }

      // Health app integration
      async function syncWithHealthApp(data) {
        try {
          const healthClient = new HealthDataClient();
          await healthClient.requestAuthorization(["calories"]);
          await healthClient.writeData({
            type: "calories",
            value: data.total.calories,
            date: new Date(),
          });
          alert("Successfully synced with health app!");
        } catch (error) {
          alert("Failed to sync with health app: " + error.message);
        }
      }

      // AR Scanner setup
      let videoStream = null;
      async function setupAR() {
        try {
          videoStream = await navigator.mediaDevices.getUserMedia({
            video: true,
          });
          const video = document.getElementById("arVideo");
          video.srcObject = videoStream;
          video.play();
          // Start continuous analysis
          analyzeLiveVideo(video);
        } catch (error) {
          alert("Failed to start AR scanner: " + error.message);
        }
      }

      async function analyzeLiveVideo(video) {
        const canvas = document.createElement("canvas");
        const interval = setInterval(async () => {
          if (
            !document.getElementById("arContainer").classList.contains("hidden")
          ) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            canvas.toBlob(async (blob) => {
              const formData = new FormData();
              formData.append("image", blob);
              try {
                const response = await fetch("/analyze", {
                  method: "POST",
                  body: formData,
                });
                const data = await response.json();
                updateAROverlay(data);
              } catch (error) {
                console.error("AR analysis failed:", error);
              }
            }, "image/jpeg");
          }
        }, 2000); // Analysis every 2 seconds

        document.getElementById("closeAR").addEventListener("click", () => {
          clearInterval(interval);
          if (videoStream) {
            videoStream.getTracks().forEach((track) => track.stop());
          }
          document.getElementById("arContainer").classList.add("hidden");
        });
      }

      // Event listeners
      document.getElementById("speakButton").addEventListener("click", () => {
        const lastAnalysis = JSON.parse(localStorage.getItem("lastAnalysis"));
        if (lastAnalysis) {
          speakAnalysis(lastAnalysis);
        }
      });

      document.getElementById("syncHealthApp").addEventListener("click", () => {
        const lastAnalysis = JSON.parse(localStorage.getItem("lastAnalysis"));
        if (lastAnalysis) {
          syncWithHealthApp(lastAnalysis);
        }
      });

      document.getElementById("startAR").addEventListener("click", () => {
        document.getElementById("arContainer").classList.remove("hidden");
        setupAR();
      });
    </script>
  </body>
</html>
